<!doctype html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:replace="~{layout/main :: layout(~{::content})}">
<div th:fragment="content">
    <!-- Hero Section - Different for Authenticated vs Anonymous -->
    <section id="hero-section" style="padding: 60px 20px; text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 40px;">
        <!-- Authenticated Users -->
        <div sec:authorize="isAuthenticated()">
            <h1 style="font-size: 2.5em; font-weight: bold; margin-bottom: 10px;">Welcome Back!</h1>
            <p style="font-size: 1.3em; color: rgba(255, 255, 255, 0.95); font-weight: 300; letter-spacing: 0.5px;">
                Continue shopping or explore new products
            </p>
        </div>

        <!-- Anonymous Users -->
        <div sec:authorize="isAnonymous()">
            <h1 style="font-size: 2.5em; font-weight: bold; margin-bottom: 10px;">Welcome to AbhiOnlineDukaan</h1>
            <p style="font-size: 1.3em; color: rgba(255, 255, 255, 0.95); font-weight: 300; letter-spacing: 0.5px;">
                Shop smart. Sell smarter.
            </p>
        </div>
    </section>

    <!-- Quick Stats Section - Only for Authenticated Users -->
    <section sec:authorize="isAuthenticated()" style="padding: 20px; max-width: 1200px; margin: 0 auto 30px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center;">
            <div style="font-size: 24px; font-weight: 700; color: #667eea;" th:text="${cartCount ?: 0}">0</div>
            <div style="font-size: 12px; color: #666; margin-top: 5px;">Items in Cart</div>
            <a href="/cart" style="display: inline-block; margin-top: 10px; color: #667eea; text-decoration: none; font-size: 12px; font-weight: 600;">Go to Cart →</a>
        </div>
        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center;">
            <div style="font-size: 24px; font-weight: 700; color: #667eea;" th:text="${pendingOrders ?: 0}">0</div>
            <div style="font-size: 12px; color: #666; margin-top: 5px;">Pending Orders</div>
            <a href="/orders" style="display: inline-block; margin-top: 10px; color: #667eea; text-decoration: none; font-size: 12px; font-weight: 600;">View Orders →</a>
        </div>
    </section>

    <!-- Featured Products Section -->
    <section id="featured-products" style="padding: 40px 20px; max-width: 1200px; margin: 0 auto;">
        <h2 style="font-size: 2em; font-weight: bold; margin-bottom: 30px; color: #333; text-align: center;">Featured Products</h2>
        
        <!-- Products Container -->
        <div id="products-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; min-height: 400px;">
            <!-- Loading Skeleton -->
            <div id="loading-message" style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #999;">
                <p>Loading products...</p>
            </div>
        </div>

        <!-- Error Message -->
        <div id="error-message" style="display: none; grid-column: 1 / -1; text-align: center; padding: 40px; color: #dc3545; background: #f8d7da; border-radius: 5px;">
            <p id="error-text">Unable to load products. Please try again later.</p>
        </div>

        <!-- View All Button -->
        <div style="text-align: center; margin-top: 40px;">
            <a href="/products-page" style="background-color: #667eea; color: white; padding: 14px 35px; font-size: 16px; font-weight: 600; text-decoration: none; border-radius: 8px; display: inline-block; transition: all 0.3s ease;">
                View All Products
            </a>
        </div>
    </section>

    <!-- CTA Section - Only for Anonymous Users -->
    <section sec:authorize="isAnonymous()" style="padding: 50px 40px; margin: 40px 20px; max-width: 1200px; margin-left: auto; margin-right: auto; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px; text-align: center;">
        <h2 style="margin: 0 0 15px 0; font-size: 2rem; font-weight: 700;">Become a Seller</h2>
        <p style="margin: 0 0 25px 0; font-size: 1.1rem; opacity: 0.95;">Start selling your products and reach thousands of customers</p>
        <a href="/seller/apply" style="background-color: white; color: #667eea; padding: 12px 40px; font-size: 16px; font-weight: 600; text-decoration: none; border-radius: 8px; display: inline-block; transition: all 0.3s ease;">
            Apply as Seller
        </a>
    </section>

    <script>
        // Fetch and display featured products on homepage
        document.addEventListener('DOMContentLoaded', function() {
            fetchFeaturedProducts();
        });

        function fetchFeaturedProducts() {
            const container = document.getElementById('products-container');
            const errorMessage = document.getElementById('error-message');
            const loadingMessage = document.getElementById('loading-message');

            // Fetch active products from API
            fetch('/api/v1/products/active/paged?size=12&sort=createdAt,desc')
                .then(response => {
                    if (!response.ok) throw new Error('Failed to fetch products');
                    return response.json();
                })
                .then(data => {
                    loadingMessage.style.display = 'none';
                    errorMessage.style.display = 'none';
                    container.innerHTML = '';

                    const products = data.data?.content || [];

                    if (products.length === 0) {
                        container.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #999;"><p>No products available at this time.</p></div>';
                        return;
                    }

                    // Create product cards
                    products.forEach(product => {
                        const productCard = createProductCard(product);
                        container.appendChild(productCard);
                    });
                })
                .catch(error => {
                    console.error('Error fetching products:', error);
                    loadingMessage.style.display = 'none';
                    container.innerHTML = '';
                    errorMessage.style.display = 'block';
                });
        }

        function createProductCard(product) {
            const card = document.createElement('div');
            card.style.cssText = 'border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden; transition: box-shadow 0.3s ease, transform 0.3s ease; background: white;';
            
            // Hover effect
            card.onmouseover = function() {
                this.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
                this.style.transform = 'translateY(-4px)';
            };
            card.onmouseout = function() {
                this.style.boxShadow = 'none';
                this.style.transform = 'translateY(0)';
            };

            // Product image
            const imageUrl = product.imageUrl || 'https://via.placeholder.com/220x220?text=No+Image';
            const imageHtml = `<img src="${imageUrl}" alt="${product.name}" style="width: 100%; height: 200px; object-fit: cover; background: #f5f5f5;">`;

            // Product details
            const detailsHtml = `
                <div style="padding: 15px;">
                    <h3 style="font-size: 0.95em; font-weight: 600; margin-bottom: 8px; color: #333; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        ${product.name}
                    </h3>
                    <p style="font-size: 0.85em; color: #666; margin-bottom: 10px; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; line-height: 1.4;">
                        ${product.description || 'Quality product'}
                    </p>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <span style="font-size: 1.3em; font-weight: bold; color: #28a745;">$${parseFloat(product.priceAmount || 0).toFixed(2)}</span>
                    </div>
                    <a href="/products-page/${product.id}" style="display: block; text-align: center; background-color: #007bff; color: white; padding: 10px; border-radius: 4px; text-decoration: none; font-weight: 600; font-size: 0.9em; transition: background-color 0.3s;">
                        View Product
                    </a>
                </div>
            `;

            card.innerHTML = imageHtml + detailsHtml;
            return card;
        }
    </script>
</div>
</html>